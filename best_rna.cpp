//
//     CTRUNCATE best routine
//     Copyright (C) Charles Ballard
//     Originally best.cc in phaser
//
//     This code is distributed under the terms and conditions of the
//     CCP4 Program Suite Licence Agreement as a CCP4 Application.
//     A copy of the CCP4 licence can be obtained by writing to the
//     CCP4 Secretary, Daresbury Laboratory, Warrington WA4 4AD, UK.
//

/*
Data derived from reasonably high resolution deposited intensities and structure factors (*).
Reference scaling against wilson curve derived using deposited structure.
Resulting structure factors averaged.
Smoothed using 0.25(n-1)+0.5(n)+0.25(n+1) over bins.

   pdb entry      scaling resolution
   -----------    ------------------
0: pdb1dno.ent    4 A -- 1.53291 A
1: pdb1en8.ent    4 A -- 1.01805 A
2: pdb1en9.ent    4 A -- 1.04743 A
3: pdb1ene.ent    4 A -- 0.992104 A
4: pdb1enn.ent    4 A -- 1.02837 A *
5: pdb1fd5.ent    4 A -- 1.4217 A
6: pdb1fq2.ent    4 A -- 1.21018 A
7: pdb1g4q.ent    4 A -- 1.30566 A *
8: pdb1i0j.ent    4 A -- 1.4929 A *
9: pdb1i0k.ent    4 A -- 1.45235 A *
10: pdb1i0m.ent    4 A -- 1.35683 A *
11: pdb1i1p.ent    4 A -- 1.67053 A
12: pdb1i5w.ent    4 A -- 1.47452 A *
13: pdb1icg.ent    4 A -- 1.62461 A *
14: pdb1l2x.ent    4 A -- 1.54912 A
15: pdb1m77.ent    4 A -- 1.38831 A *
16: pdb1o0k.ent    4 A -- 1.44751 A
17: pdb1pjg.ent    4 A -- 1.25047 A *
18: pdb1pjo.ent    4 A -- 1.23787 A *
19: pdb1pwf.ent    4 A -- 1.45589 A
20: pdb1q9a.ent    4 A -- 1.36161 A
21: pdb1r3g.ent    4 A -- 1.39914 A *
22: pdb1wtq.ent    4 A -- 1.69704 A
23: pdb1xuw.ent    4 A -- 1.44431 A
24: pdb1xux.ent    4 A -- 1.34719 A
25: pdb1yb9.ent    4 A -- 1.66402 A *
26: pdb1z7i.ent    4 A -- 1.55074 A *
27: pdb2a43.ent    4 A -- 1.55066 A
28: pdb2a7e.ent    4 A -- 1.69316 A *
29: pdb2b3e.ent    4 A -- 1.62471 A
30: pdb2dlj.ent    4 A -- 1.64155 A
31: pdb2elg.ent    4 A -- 1.11803 A *
32: pdb2fii.ent    4 A -- 1.34557 A
33: pdb2hc7.ent    4 A -- 1.52189 A *
34: pdb2jja.ent    4 A -- 1.55428 A *
35: pdb2nsk.ent    4 A -- 1.68732 A *
36: pdb2o1i.ent    4 A -- 1.58437 A
37: pdb2q1o.ent    4 A -- 1.19413 A
38: pdb2q1r.ent    4 A -- 1.2269 A
39: pdb2v7r.ent    4 A -- 1.38572 A *
40: pdb2vuq.ent    4 A -- 1.50738 A *
41: pdb397d.ent    4 A -- 1.65395 A
42: pdb3cgp.ent    4 A -- 1.69407 A
43: pdb3dvz.ent    4 A -- 1.18126 A *
44: pdb3dw4.ent    4 A -- 1.20305 A *
45: pdb3dw5.ent    4 A -- 1.10854 A *
46: pdb3dw6.ent    4 A -- 1.18126 A *
47: pdb3glp.ent    4 A -- 1.56776 A *
48: pdb3hg8.ent    4 A -- 1.52708 A *
49: pdb3ijk.ent    4 A -- 1.63709 A *
50: pdb3iki.ent    4 A -- 1.52708 A *
51: pdb3jxr.ent    4 A -- 1.44565 A *
52: pdb3ltu.ent    4 A -- 1.40032 A *
53: pdb3nd3.ent    4 A -- 1.65788 A
54: pdb3nj6.ent    4 A -- 1.03252 A
55: pdb3nyp.ent    4 A -- 1.66736 A
56: pdb3nz7.ent    4 A -- 1.10004 A
57: pdb3omj.ent    4 A -- 1.28693 A *
58: pdb3p4a.ent    4 A -- 1.52495 A
59: pdb3p4c.ent    4 A -- 1.39036 A
60: pdb3s7c.ent    4 A -- 1.38246 A *
61: pdb3s8u.ent    4 A -- 1.54935 A *
62: pdb466d.ent    4 A -- 1.53957 A *
63: pdb476d.ent    4 A -- 1.54098 A *
64: pdb483d.ent    4 A -- 1.4479 A
65: pdb4fe5.ent    4 A -- 1.63652 A *

chi2 data derived using 

      chi2 = sum(xi -<x>)
             -----------
               N-1

for each bin.
      
*/


#include "best_rna.h"
#include <cmath>

namespace ctruncate {

	static float best_rna[300] = {
		56172.493,
		52994.527,
		51523.558,
		54136.017,
		59466.005,
		65974.592,
		72846.527,
		79737.068,
		86625.328,
		93355.608,
		99598.716,
		105063.995,
		109510.228,
		112706.725,
		114751.589,
		116152.139,
		117379.855,
		118478.759,
		119105.458,
		118790.553,
		117015.828,
		113254.777,
		107136.787,
		98932.929,
		89313.574,
		79055.578,
		69435.191,
		61565.816,
		55807.523,
		51895.541,
		49223.155,
		47355.830,
		46056.008,
		45086.206,
		44240.483,
		43403.125,
		42537.519,
		41652.123,
		40779.183,
		39987.901,
		39374.112,
		38988.865,
		38844.260,
		38920.807,
		39110.303,
		39261.266,
		39292.539,
		39200.108,
		39044.438,
		38939.838,
		38958.544,
		39080.205,
		39230.003,
		39324.978,
		39302.098,
		39144.670,
		38879.600,
		38549.121,
		38181.969,
		37793.800,
		37381.432,
		36908.337,
		36361.412,
		35770.386,
		35164.740,
		34568.039,
		34011.499,
		33531.136,
		33144.654,
		32832.886,
		32558.324,
		32297.494,
		32055.384,
		31870.030,
		31790.899,
		31860.660,
		32091.170,
		32433.200,
		32801.941,
		33106.804,
		33281.567,
		33295.660,
		33159.675,
		32869.752,
		32404.759,
		31822.841,
		31166.096,
		30444.442,
		29672.330,
		28854.113,
		27997.249,
		27089.568,
		26166.053,
		25262.182,
		24398.650,
		23624.983,
		22949.884,
		22352.669,
		21833.708,
		21372.302,
		20909.704,
		20469.220,
		20066.792,
		19653.596,
		19281.087,
		18983.430,
		18722.640,
		18438.583,
		18130.718,
		17903.017,
		17740.407,
		17587.110,
		17469.170,
		17333.254,
		17105.749,
		16879.810,
		16764.091,
		16709.856,
		16632.291,
		16527.176,
		16445.261,
		16388.948,
		16253.405,
		16042.110,
		15846.236,
		15638.562,
		15488.531,
		15450.050,
		15440.771,
		15387.018,
		15224.012,
		15037.797,
		14955.791,
		14937.634,
		14931.605,
		14937.843,
		14950.012,
		14968.969,
		14998.409,
		15040.323,
		15094.019,
		15112.177,
		15088.051,
		15110.428,
		15181.504,
		15155.648,
		15035.169,
		15019.483,
		15103.551,
		15185.009,
		15262.111,
		15331.033,
		15390.186,
		15442.147,
		15431.741,
		15357.588,
		15333.684,
		15350.784,
		15353.671,
		15365.210,
		15333.300,
		15245.120,
		15200.809,
		15200.283,
		15179.588,
		15132.229,
		15055.562,
		14949.092,
		14842.309,
		14685.279,
		14461.982,
		14279.601,
		14067.283,
		13770.599,
		13536.869,
		13376.408,
		13224.255,
		13089.395,
		12974.218,
		12874.670,
		12790.685,
		12720.724,
		12664.323,
		12621.596,
		12588.936,
		12559.990,
		12526.731,
		12483.768,
		12429.906,
		12363.180,
		12283.680,
		12194.790,
		12096.131,
		11970.487,
		11818.452,
		11676.650,
		11568.778,
		11481.442,
		11381.939,
		11292.605,
		11216.937,
		11096.976,
		10944.252,
		10789.919,
		10631.043,
		10468.070,
		10305.826,
		10151.165,
		10000.720,
        9847.483,
        9693.712,
        9545.360,
        9402.930,
        9262.131,
        9123.385,
        8994.889,
        8877.351,
        8761.817,
        8647.406,
        8539.233,
        8469.907,
        8433.087,
        8357.189,
        8243.495,
        8130.288,
        8019.402,
        7908.609,
        7856.223,
        7806.608,
        7647.618,
        7493.418,
        7389.645,
        7274.862,
        7322.849,
        7533.960,
        7574.274,
        7435.495,
        7269.655,
        7088.116,
        6909.037,
        6739.958,
        6588.798,
        6454.813,
        6336.684,
        6235.473,
        6148.782
	};
	
	static float best_rna_chi2[300] = {
		27519.015,
		24699.678,
		21962.808,
		20186.005,
		19339.798,
		19415.570,
		19670.451,
		19570.748,
		19184.604,
		18991.814,
		19779.787,
		21697.591,
		23768.904,
		25009.171,
		25274.068,
		24984.547,
		24542.616,
		24076.328,
		23682.124,
		23349.923,
		22747.182,
		21699.705,
		20282.762,
		18608.194,
		16835.850,
		15048.149,
		13174.866,
		11104.825,
        9096.408,
        7648.204,
        6796.845,
        6189.868,
        5690.341,
        5421.655,
        5413.969,
        5518.840,
        5613.474,
        5697.833,
        5784.945,
        5795.160,
        5624.071,
        5299.588,
        4959.033,
        4697.785,
        4515.754,
        4403.637,
        4378.685,
        4463.029,
        4662.404,
        4914.010,
        5119.968,
        5224.395,
        5211.996,
        5094.207,
        4910.447,
        4713.179,
        4544.697,
        4416.254,
        4313.031,
        4194.255,
        4054.314,
        3944.810,
        3877.572,
        3826.278,
        3764.430,
        3682.793,
        3613.704,
        3573.474,
        3534.588,
        3499.602,
        3497.556,
        3528.289,
        3582.988,
        3670.375,
        3790.753,
        3909.943,
        3979.697,
        3982.053,
        3956.600,
        3944.458,
        3933.231,
        3913.143,
        3852.023,
        3786.357,
        3827.037,
        3897.844,
        3910.640,
        3901.376,
        3891.601,
        3858.141,
        3715.272,
        3484.755,
        3275.122,
        3079.063,
        2898.478,
        2786.863,
        2737.875,
        2719.649,
        2704.554,
        2691.751,
        2687.198,
        2683.777,
        2689.479,
        2698.608,
        2692.633,
        2673.607,
        2657.538,
        2561.496,
        2381.269,
        2290.017,
        2294.009,
        2312.466,
        2345.121,
        2361.870,
        2351.506,
        2359.400,
        2396.979,
        2449.233,
        2504.134,
        2546.337,
        2570.424,
        2573.950,
        2507.817,
        2385.867,
        2286.065,
        2219.385,
        2213.620,
        2245.581,
        2268.264,
        2266.609,
        2158.713,
        1985.871,
        1931.093,
        1976.343,
        1993.585,
        1982.926,
        1973.318,
        1968.442,
        1970.621,
        1980.244,
        1997.808,
        1999.048,
        1977.948,
        1977.887,
        1999.690,
        1823.938,
        1458.330,
        1300.260,
        1340.203,
        1375.929,
        1407.516,
        1436.053,
        1463.716,
        1487.828,
        1445.141,
        1343.032,
        1305.905,
        1332.816,
        1357.207,
        1360.929,
        1305.429,
        1205.407,
        1148.434,
        1138.751,
        1149.701,
        1183.571,
        1220.899,
        1250.654,
        1262.337,
        1217.220,
        1128.145,
        1076.821,
        1047.061,
		991.320,
		935.851,
		898.185,
		874.928,
		860.204,
		844.448,
		821.369,
		791.784,
		756.694,
		716.530,
		680.724,
		662.414,
		661.336,
		670.720,
		685.576,
		699.852,
		710.650,
		716.136,
		712.842,
		699.660,
		683.475,
		665.798,
		637.610,
		610.275,
		594.609,
		578.604,
		562.956,
		567.968,
		593.517,
		615.390,
		631.812,
		651.301,
		673.246,
		695.268,
		709.416,
		712.260,
		708.571,
		700.453,
		687.057,
		672.868,
		653.750,
		624.456,
		594.598,
		572.838,
		562.919,
		565.406,
		575.451,
		586.460,
		600.147,
		618.370,
		632.198,
		640.468,
		651.015,
		661.446,
		646.812,
		633.484,
		680.945,
		761.619,
		837.613,
		894.567
	};
	
    clipper::ftype Best_rna::invresolsq_min()
    {
        return offset;
    }
    
    clipper::ftype Best_rna::invresolsq_max()
    {
        return (sizeof(best_rna)/sizeof(float)-1.0)*step+offset;
    }
    
    bool Best_rna::contains(const clipper::ftype ssqr)
    {
        return (ssqr > offset && ssqr < offset+(sizeof(best_rna)/sizeof(float)-1.0)*step);
    }

    clipper::ftype Best_rna::value(const clipper::ftype ssqr)
    {
        int s1 = (int) std::floor((ssqr - offset)/step); //truncations to lower value
        if (s1 < 0) return clipper::Util::nan(); //lower than 10.5409 A resolution
        const unsigned int best_limit = sizeof(best_rna)/sizeof(float)-1;
        if (s1 > best_limit) return clipper::Util::nan(); //beyond highest resolution for BEST data (about 0.9 A)
        //linear interpolation
        double ssqr1 = s1*step + offset;
        double frac = (ssqr - ssqr1)/step;
        return k*((1.0-frac)*best_rna[s1]+frac*best_rna[s1+1]);
    }
	
}
